### create users
export COMPARTMENT_ID=`oci iam compartment list \
--profile DBSEC \
--access-level ACCESSIBLE \
--name LoggingAnalytics \
--compartment-id ocid1.tenancy.oc1..aaaaaaaanpuxsacx2rn22ycwc7ugp3sqzfvfhvyrrkmd7eanmvqd6bg7innq \
--compartment-id-in-subtree true | jq -r .data[].id`
echo $COMPARTMENT_ID


rm -rf create_analytic_users.sh
INSTANCE_COUNT=10
for (( INDEX=0; INDEX<=$INSTANCE_COUNT-1; INDEX++ ))
do
cat << EOF >> create_analytic_users.sh
oci iam user create \\
--profile DBSEC \\
--description "user for HOL analytics workshop" \\
--compartment-id  ocid1.tenancy.oc1..aaaaaaaanpuxsacx2rn22ycwc7ugp3sqzfvfhvyrrkmd7eanmvqd6bg7innq \\
--email analytics`printf %03d $INDEX`@no.com \\
--name analytics`printf %03d $INDEX` | jq -r .data.id

EOF
done
chmod u+x create_analytic_users.sh
./create_analytic_users.sh > oci_analytics_users_id.txt



input="oci_analytics_users_id.txt"
rm -rf update_ui_paaswd.sh
while IFS= read -r line
do
cat << EOF >> update_ui_paaswd.sh
oci iam user ui-password create-or-reset \\
--profile DBSEC \\
--user-id $line 

EOF
done < "$input"
cat update_ui_paaswd.sh
chmod u+x update_ui_paaswd.sh
./update_ui_paaswd.sh > analytic_users_passwords.txt	

### add users to group

input="oci_analytics_users_id.txt"
rm -rf add_users_group.sh
while IFS= read -r line
do
cat << EOF >> add_users_group.sh
oci iam group add-user \\
--profile DBSEC \\
--group-id \\
--user-id $line 

EOF
done < "$input"
cat add_users_group.sh
chmod u+x add_users_group.sh
./add_users_group.sh






oci iam user delete  \\
-- profile DBSEC \\
--user-id  \\
--force

oci iam user ui-password create-or-reset \


#### get the state of the tenancy
cat<<EOF> namespace_list.json
{
"all": true,
"compartmentId": "ocid1.tenancy.oc1..aaaaaaaanpuxsacx2rn22ycwc7ugp3sqzfvfhvyrrkmd7eanmvqd6bg7innq"
}
EOF
export NameSpace=`oci log-analytics namespace list \
--profile DBSEC \
--from-json file://namespace_list.json | jq  '.data.items[]  | "\(."namespace-name") \(."is-onboarded")"' |sed 's/"//g' | awk '{print $1}'`


#### enroll the tenancy to analytics
cat<<EOF> namespace_onboard.json
{
"namespaceName": "$NameSpace"
}
EOF
cat namespace_onboard.json
oci log-analytics namespace onboard \
--profile DBSEC \
--from-json file://namespace_onboard.json
#####
sleep 20
#### show the state of the analytics
oci log-analytics namespace list \
--profile DBSEC \
--from-json file://namespace_list.json | jq  '.data.items[]  | "\(."namespace-name") \(."is-onboarded")"'
#####
##### at this point the logging-analytics is activated for the tenancy
#####
wget https://objectstorage.us-phoenix-1.oraclecloud.com/p/RHMd3hXQ4v33Bm7YE6IONjSvsNPFBNAf7BkcVgysjr9wgNA3gzZEB5DevHqkMR1t/n/ax1zffkcg1fy/b/oci_quick_start_script_do_not_delete/o/logging-analytics-demo-v1.0.zip
unzip logging-analytics-demo-v1.0.zip
cd logging-analytics-demo
./setup.sh


#### clean up 
cat<<EOF> namespace_list.json
{
"all": true,
"compartmentId": "ocid1.tenancy.oc1..aaaaaaaanpuxsacx2rn22ycwc7ugp3sqzfvfhvyrrkmd7eanmvqd6bg7innq"
}
EOF
export NAMESPACE=`oci log-analytics namespace list \
--profile DBSEC \
--from-json file://namespace_list.json | jq  '.data.items[]  | "\(."namespace-name") \(."is-onboarded")"' |sed 's/"//g' | awk '{print $1}'`

export NAMESPACE=`oci os ns get | jq -r .data`

oci log-analytics namespace offboard \
--profile DBSEC \
--namespace-name $NAMESPACE

export NAMESPACE=`oci os ns get | jq -r .data`
oci log-analytics namespace offboard \
--namespace-name $NAMESPACE
###--from-json file://namespace_onboard.json



oci log-analytics upload list \
--profile DBSEC \
--namespace-name frnj6sfkc1ep



export LOG_GROUP_ID=`oci log-analytics log-group list \
--profile DBSEC \
--namespace-name frnj6sfkc1ep \
--compartment-id ocid1.compartment.oc1..aaaaaaaapupdmzvxfppkqpfxf6wyn5oud5vsazw4houfucda4qnsk4znbeba \
| jq -r '.data.items[].id '`	
echo $LOG_GROUP_ID

oci log-analytics log-group delete \
--profile DBSEC \
--namespace-name 		 frnj6sfkc1ep \
--log-group-id $LOG_GROUP_ID
--force			  


oci log-analytics entity list \
--profile DBSEC \
--namespace-name frnj6sfkc1ep \
--compartment-id ocid1.compartment.oc1..aaaaaaaapupdmzvxfppkqpfxf6wyn5oud5vsazw4houfucda4qnsk4znbeba | jq -r 'data.items[]'


oci log-analytics entity list-associations     \
--profile DBSEC \
--namespace-name frnj6sfkc1ep \
--direct-or-all ALL \
--entity-id ocid1.loganalyticsentity.oc1.eu-frankfurt-1.amaaaaaaufnzx7iacw4gpicddxwnf5ofb7bawah6mr6fxlpfjtdcjypw5iqa


#### get the id of the entities
rm -rf entity_ids.txt
oci log-analytics entity list \
--profile DBSEC \
--namespace-name frnj6sfkc1ep \
--compartment-id ocid1.compartment.oc1..aaaaaaaapupdmzvxfppkqpfxf6wyn5oud5vsazw4houfucda4qnsk4znbeba \
| jq  '.data.items[] | "\(."are-logs-collected") \(."entity-type-internal-name") \(."entity-type-name") \(."name")   \(.id)"' | sed 's/"//g' | awk '{print $NF}' > entity_ids.txt
cat entity_ids.txt

### delete the entities
export NAME_SPACE="frnj6sfkc1ep"
input="entity_ids.txt"
rm -rf delete_entities.sh
while IFS= read -r line
do
cat << EOF >> delete_entities.sh
echo "***********" $line "**************"
oci log-analytics entity delete \
--profile DBSEC \
--entity-id $line \
--namespace-name $NAME_SPACE \
--force
EOF
done < "$input"
cat delete_entities.sh
chmod u+x delete_entities.sh 
./delete_entities.sh





{
  "are-logs-collected": true,
  "cloud-resource-id": null,
  "compartment-id": "ocid1.compartment.oc1..aaaaaaaapupdmzvxfppkqpfxf6wyn5oud5vsazw4houfucda4qnsk4znbeba",
  "defined-tags": {
    "Oracle-Tags": {
      "CreatedBy": "oracleidentitycloudservice/eugene.simos@oracle.com"
    }
  },
  "entity-type-internal-name": "oci_api_gateway",
  "entity-type-name": "OCI API Gateway",
  "freeform-tags": {},
  "id": "ocid1.loganalyticsentity.oc1.eu-frankfurt-1.amaaaaaaufnzx7iakbisz5wqugh56bzwx272224uopkhv7zeoeoakmaqomcq",
  "lifecycle-details": "READY",
  "lifecycle-state": "ACTIVE",
  "management-agent-id": null,
  "name": "apigw1.oracle.com",
  "source-id": null,
  "time-created": "2021-01-20T10:43:22.865000+00:00",
  "time-updated": "2021-01-20T10:43:22.865000+00:00",
  "timezone-region": null
}
{
  "are-logs-collected": true,
  "cloud-resource-id": null,
  "compartment-id": "ocid1.compartment.oc1..aaaaaaaapupdmzvxfppkqpfxf6wyn5oud5vsazw4houfucda4qnsk4znbeba",
  "defined-tags": {
    "Oracle-Tags": {
      "CreatedBy": "oracleidentitycloudservice/eugene.simos@oracle.com"
    }
  },
  "entity-type-internal-name": "omc_host_linux",
  "entity-type-name": "Host (Linux)",
  "freeform-tags": {},
  "id": "ocid1.loganalyticsentity.oc1.eu-frankfurt-1.amaaaaaaufnzx7ian36ty3klbps4wgw5rvoppm2sfjf3bimhoiopm3uosfgq",
  "lifecycle-details": "READY",
  "lifecycle-state": "ACTIVE",
  "management-agent-id": null,
  "name": "srx-test.oracle.com",
  "source-id": null,
  "time-created": "2021-01-20T10:43:04.756000+00:00",
  "time-updated": "2021-01-20T10:43:04.756000+00:00",
  "timezone-region": null
}
{
  "are-logs-collected": true,
  "cloud-resource-id": null,
  "compartment-id": "ocid1.compartment.oc1..aaaaaaaapupdmzvxfppkqpfxf6wyn5oud5vsazw4houfucda4qnsk4znbeba",
  "defined-tags": {
    "Oracle-Tags": {
      "CreatedBy": "oracleidentitycloudservice/eugene.simos@oracle.com"
    }
  },
  "entity-type-internal-name": "omc_host_linux",
  "entity-type-name": "Host (Linux)",
  "freeform-tags": {},
  "id": "ocid1.loganalyticsentity.oc1.eu-frankfurt-1.amaaaaaaufnzx7iaghd5bba5zlbyjuvzcdo6vplq6niuo6wsvghbcpi2j64q",
  "lifecycle-details": "READY",
  "lifecycle-state": "ACTIVE",
  "management-agent-id": null,
  "name": "bigip-ltm-dmz1.oracle.com",
  "source-id": null,
  "time-created": "2021-01-20T10:42:50.509000+00:00",
  "time-updated": "2021-01-20T10:42:50.509000+00:00",
  "timezone-region": null
}
{
  "are-logs-collected": true,
  "cloud-resource-id": null,
  "compartment-id": "ocid1.compartment.oc1..aaaaaaaapupdmzvxfppkqpfxf6wyn5oud5vsazw4houfucda4qnsk4znbeba",
  "defined-tags": {
    "Oracle-Tags": {
      "CreatedBy": "oracleidentitycloudservice/eugene.simos@oracle.com"
    }
  },
  "entity-type-internal-name": "omc_host_linux",
  "entity-type-name": "Host (Linux)",
  "freeform-tags": {},
  "id": "ocid1.loganalyticsentity.oc1.eu-frankfurt-1.amaaaaaaufnzx7ia4rrrxmdcxwlleoqsto3nikpoqwk4xgqf4krfheywxz6q",
  "lifecycle-details": "READY",
  "lifecycle-state": "ACTIVE",
  "management-agent-id": null,
  "name": "dbhost1.oracle.com",
  "source-id": null,
  "time-created": "2021-01-20T10:42:20.617000+00:00",
  "time-updated": "2021-01-20T10:42:20.617000+00:00",
  "timezone-region": null
}
{
  "are-logs-collected": true,
  "cloud-resource-id": null,
  "compartment-id": "ocid1.compartment.oc1..aaaaaaaapupdmzvxfppkqpfxf6wyn5oud5vsazw4houfucda4qnsk4znbeba",
  "defined-tags": {
    "Oracle-Tags": {
      "CreatedBy": "oracleidentitycloudservice/eugene.simos@oracle.com"
    }
  },
  "entity-type-internal-name": "omc_oracle_db_instance",
  "entity-type-name": "Oracle Database Instance",
  "freeform-tags": {},
  "id": "ocid1.loganalyticsentity.oc1.eu-frankfurt-1.amaaaaaaufnzx7iacw4gpicddxwnf5ofb7bawah6mr6fxlpfjtdcjypw5iqa",
  "lifecycle-details": "READY",
  "lifecycle-state": "ACTIVE",
  "management-agent-id": null,
  "name": "db1",
  "source-id": null,
  "time-created": "2021-01-20T10:41:59.840000+00:00",
  "time-updated": "2021-01-20T10:41:59.840000+00:00",
  "timezone-region": null
}



oci log-analytics entity get \
--profile DBSEC \
--namespace-name frnj6sfkc1ep \
--entity-id ocid1.loganalyticsentity.oc1.eu-frankfurt-1.amaaaaaaufnzx7iakbisz5wqugh56bzwx272224uopkhv7zeoeoakmaqomcq | jq -r  .data

{
  "are-logs-collected": true,
  "cloud-resource-id": null,
  "compartment-id": "ocid1.compartment.oc1..aaaaaaaapupdmzvxfppkqpfxf6wyn5oud5vsazw4houfucda4qnsk4znbeba",
  "defined-tags": {
    "Oracle-Tags": {
      "CreatedBy": "oracleidentitycloudservice/eugene.simos@oracle.com"
    }
  },
  "entity-type-internal-name": "oci_api_gateway",
  "entity-type-name": "OCI API Gateway",
  "freeform-tags": {},
  "hostname": null,
  "id": "ocid1.loganalyticsentity.oc1.eu-frankfurt-1.amaaaaaaufnzx7iakbisz5wqugh56bzwx272224uopkhv7zeoeoakmaqomcq",
  "lifecycle-details": "READY",
  "lifecycle-state": "ACTIVE",
  "management-agent-compartment-id": null,
  "management-agent-display-name": null,
  "management-agent-id": null,
  "name": "apigw1.oracle.com",
  "properties": {},
  "source-id": null,
  "time-created": "2021-01-20T10:43:22.865000+00:00",
  "time-updated": "2021-01-20T10:43:22.865000+00:00",
  "timezone-region": null
}



oci log-analytics entity create --generate-full-command-json-input
{
  "compartmentId": "$LOG_COMP_ID",
  "entityTypeName": "$ENTITY_TYPE",
  "freeformTags": {
      "Createdby": "oci_cli",
      "Creator": "Eugene Simos",
	  "Project" : "analytics HOL"
  },
  "name": "$ENTITY_NAME",
  "namespace": "$NAME_SPACE"
}

oci log-analytics entity delete \
--profile DBSEC \
--entity-id \
--namespace-name \
--force

oci logging log-group list \
--compartment-id $COMPARTMENTID \
--display-name logging-analytics-demo | jq -r .data[].id